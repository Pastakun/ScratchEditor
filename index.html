<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScratchEditor</title>
</head>
<body>
    <input type="file" id="file-input" />
    <pre id="jsonoutput"></pre>
    <textarea id="code"></textarea>
    <br>
    <textarea id="output"></textarea>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    JSZip.loadAsync(arrayBuffer).then(function(zip) {
                        return zip.file('project.json').async('string');
                    }).then(function(jsonStr) {
                        document.getElementById('jsonoutput').textContent = jsonStr;
                        console.log(jsonStr);
                        const projectJson = JSON.parse(jsonStr);
                        console.log(projectJson);
                    }).catch(function(err) {
                        console.error('Error reading zip file:', err);
                    });
                };
                reader.readAsArrayBuffer(file);
            }
        });
        document.getElementById('code').addEventListener('change', function(event) {
            const tokens = [];
            let currentToken = '';
            for (let i = 0; i < document.getElementById('code').value.length; i++) {
                const char = document.getElementById('code').value[i];

                if (char === '(' || char === ')' || char === ',') {
                    if (currentToken !== '') {
                        tokens.push(currentToken);
                        currentToken = '';
                    }
                    tokens.push(char);
                } else if (char === ' ' || char === '\n') {
                    if (currentToken !== '') {
                        tokens.push(currentToken);
                        currentToken = '';
                    }
                } else {
                    currentToken += char;
                }
            }
            if (currentToken !== '') {
                tokens.push(currentToken);
            }
            let projectjson = {"targets":[{"isStage":true,"name":"Stage","variables":{"`jEk@4|i[#Fk?(8x)AV.-my variable":["my variable",0]},"lists":{},"broadcasts":{},"blocks":{},"comments":{},"currentCostume":0,"costumes":[{"name":"backdrop1","dataFormat":"svg","assetId":"cd21514d0531fdffb22204e0ec5ed84a","md5ext":"cd21514d0531fdffb22204e0ec5ed84a.svg","rotationCenterX":240,"rotationCenterY":180}],"sounds":[{"name":"pop","assetId":"83a9787d4cb6f3b7632b4ddfebf74367","dataFormat":"wav","format":"","rate":48000,"sampleCount":1123,"md5ext":"83a9787d4cb6f3b7632b4ddfebf74367.wav"}],"volume":100,"layerOrder":0,"tempo":60,"videoTransparency":50,"videoState":"on","textToSpeechLanguage":null},{"isStage":false,"name":"Glow-A","variables":{},"lists":{},"broadcasts":{},"blocks":{},"comments":{},"currentCostume":0,"costumes":[{"name":"Glow-A","bitmapResolution":1,"dataFormat":"svg","assetId":"fd470938cce54248aaf240b16e845456","md5ext":"fd470938cce54248aaf240b16e845456.svg","rotationCenterX":36,"rotationCenterY":37}],"sounds":[{"name":"pop","assetId":"83a9787d4cb6f3b7632b4ddfebf74367","dataFormat":"wav","format":"","rate":48000,"sampleCount":1123,"md5ext":"83a9787d4cb6f3b7632b4ddfebf74367.wav"}],"volume":100,"layerOrder":1,"visible":true,"x":0,"y":0,"size":100,"direction":90,"draggable":false,"rotationStyle":"all around"}],"monitors":[],"extensions":[],"meta":{"semver":"3.0.0","vm":"0.2.0","agent":"","platform":{"name":"ScratchEditor","url":"https://pastakun.github.io/ScratchEditor/"}}};
            let parent = 0;
            let blocks = [];
            let blocksid = [];
            let lastparent = null;
            for (let i = 0; i < tokens.length; i++) {
                if(Object.keys(blockopcode).includes(tokens[i])){
                    let blockjson = {'opcode':blockopcode[tokens[i]],'next':null,'inputs':{},'fields':{},'shadow':false,'topLevel':false};
                    if(parent === 0){
                        blockjson.parent = null;
                        blockjson.topLevel = true;
                        blockjson.x = 0;
                        blockjson.y = 0;
                    }else{
                        if(blocks.length === 0){
                            blockjson.parent = lastparent;
                            projectjson.targets[1].blocks[lastparent].next = 'a' + parent;
                        }else if(blocks[blocks.length - 1].opcode === 'control_if_else'){
                            blockjson.parent = lastparent;
                            if(lastparent === blocksid[blocksid.length - 1]){
                                blocks[blocks.length - 1].inputs[blockinput[blocks[blocks.length - 1].opcode][Object.keys(blocks[blocks.length - 1].inputs).length]] = [3,'a' + parent,[4,""]];
                            }else{
                                projectjson.targets[1].blocks[lastparent].next = 'a' + parent;
                            }
                        }else{
                            blockjson.parent = blocksid[blocksid.length - 1];
                            blocks[blocks.length - 1].inputs[blockinput[blocks[blocks.length - 1].opcode][Object.keys(blocks[blocks.length - 1].inputs).length]] = [3,'a' + parent,[4,""]];
                        }
                    }
                    blocks.push(blockjson);
                    blocksid.push('a' + parent);
                    if(blockopcode[tokens[i]] === 'control_if_else'){
                        lastparent = 'a' + parent;
                    }
                    parent++
                }else if(tokens[i] === ')' || tokens[i] === ','){
                    if(tokens[i - 1] !== ')' && tokens[i - 1] !== '('){
                        blocks[blocks.length - 1].inputs[blockinput[blocks[blocks.length - 1].opcode][Object.keys(blocks[blocks.length - 1].inputs).length]] = [1,[4,tokens[i - 1]]];
                    }
                    if(tokens[i] === ')'){
                        console.log(blocksid[blocksid.length - 1], blocks[blocks.length - 1]);
                        projectjson.targets[1].blocks[blocksid[blocksid.length - 1]] = blocks[blocks.length - 1];
                        next = blocksid[blocksid.length - 1];
                        blocks.pop();
                        blocksid.pop();
                        if(blocks.length === 0){
                            lastparent = next;
                        }else if(lastparent === blocksid[blocksid.length - 1]){
                            lastparent = next;
                        }
                    }else{
                        if((tokens[i - 1] === ')' && blocks[blocks.length - 1].opcode === 'control_if_else')){
                            lastparent = blocksid[blocksid.length - 1];
                        }
                    }
                }
            }
            document.getElementById('output').value = JSON.stringify(projectjson);
        });
        const blockinput = {'motion_movesteps': ['STEPS'], 'motion_turnright': ['DEGREES'], 'operator_add': ['NUM1', 'NUM2'], 'event_whenflagclicked': [], 'control_if_else': ['CONDITION', 'SUBSTACK', 'SUBSTACK2'], 'operator_equals': ['OPERAND1', 'OPERAND2']};
        const blockopcode = {'steps': 'motion_movesteps', 'right': 'motion_turnright','add': 'operator_add', 'start': 'event_whenflagclicked', 'ifelse': 'control_if_else', 'equals': 'operator_equals'}
    </script>
</body>
</html>
